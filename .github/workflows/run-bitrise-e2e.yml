name: Run Bitrise E2E

on:
  pull_request:
    types: [labeled]

jobs:
  check-label:
    runs-on: ubuntu-latest
    steps:
      - name: Check for Run E2E label
        uses: actions/github-script@v5
        with:
          script: |
            const issue_number = context.issue.number;
            let labelExists;
            try {
              const { data: labels } = await github.rest.issues.listLabelsOnIssue({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue_number
              });
              labelExists = labels.some(label => label.name === 'Run E2E');
              console.log(labelExists ? 'Found Run E2E label, moving on to next job.' : 'Run E2E label does not exist, skipping other jobs.');
            } catch (error) {
              const pullRequestLink = `https://github.com/MetaMask/metamask-mobile/pull/${issue_number}`;
              console.log(`Failed to check for Run E2E label on PR ${pullRequestLink}: ${error}`);
            }
            return labelExists;
    outputs:
      runE2ELabelExists: ${{ steps.label-check.outputs.result }}

  run-bitrise-e2e:
    runs-on: ubuntu-latest
    needs: check-label
    if: needs.check-label.outputs.runE2ELabelExists == 'true'
    permissions:
      pull-requests: write
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version-file: '.nvmrc'
          cache: yarn

      - name: Install Axios
        run: yarn add axios

      - name: Install dependencies
        run: yarn --immutable

      - name: Run Bitrise E2E
        env:
          BITRISE_BUILD_TRIGGER_TOKEN: ${{ secrets.BITRISE_BUILD_TRIGGER_TOKEN }}
          BITRISE_APP_ID: 'be69d4368ee7e86d'
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: yarn run run-bitrise-e2e
